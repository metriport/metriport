import { Bundle, Resource } from "@medplum/fhirtypes";
import { FhirBundleSdk } from "@metriport/fhir-sdk";
import { AnthropicAgent } from "../bedrock/agent/anthropic";
import { ComprehendClient } from "./client";
import { buildComprehendMedicationTool } from "./medication/medication-tool";

export const COMPREHEND_SYSTEM_PROMPT = `Your role is to choose an extraction tool from the provided tools, and use them with substrings of medical text provided by the user.
The extraction tools are specialized in extracting coded FHIR resources from the medical text, and modifying the FHIR resources generated by previous tool calls.
You should pass substrings of text and FHIR resources to extraction tools without modification. Do not produce any output or tell me what you are doing. I will not 
run the tool if the substring is not found in the original text. Do not pass the same text to multiple tools, pick the most relevant tool. Try to pass the most 
concise possible substring of text to the extraction tools, but don't leave out any important details.`;

export class ComprehendAgent extends AnthropicAgent<"claude-sonnet-3.7"> {
  private readonly bundle: Bundle;
  private readonly fhirSdk: FhirBundleSdk;

  constructor(bundle: Bundle, comprehend: ComprehendClient = new ComprehendClient()) {
    super({
      version: "claude-sonnet-3.7",
      region: "us-east-1",
      systemPrompt: COMPREHEND_SYSTEM_PROMPT,
      tools: [buildComprehendMedicationTool(bundle, comprehend)],
      maxTokens: 10000,
    });
    this.bundle = bundle;
    this.fhirSdk = FhirBundleSdk.createSync(bundle);
  }

  async extractResources(text: string): Promise<Resource[]> {
    let response = await this.startConversation(text);
    if (!this.shouldExecuteTools(response)) return [];

    do {
      await this.executeTools(response);
      response = await this.continueConversation();
    } while (this.shouldExecuteTools(response));

    return [];
  }
}
