import type { Migration } from "..";

const tableName = "tcm_encounter";
const columnName = "has_cardiac_code";

export const up: Migration = async ({ context: queryInterface }) => {
  await queryInterface.sequelize.transaction(async transaction => {
    await queryInterface.sequelize.query(
      `
      ALTER TABLE ${tableName} 
      ADD COLUMN ${columnName} BOOLEAN 
      GENERATED ALWAYS AS (
        jsonb_path_query_array(clinical_information, '$.condition[*].coding[*].code')
        ?| ARRAY['${cardiacCodes.join("', '")}']
      ) STORED;
      `,
      { transaction }
    );
  });

  // Create index outside transaction (CONCURRENTLY cannot run inside transaction)
  await queryInterface.sequelize.query(`
    CREATE INDEX IF NOT EXISTS idx_tcm_encounter_cardiac_code 
      ON ${tableName} (${columnName}) 
      WHERE ${columnName} = true;
  `);
};

export const down: Migration = async ({ context: queryInterface }) => {
  // Drop the index outside of transaction
  await queryInterface.sequelize.query(
    `DROP INDEX CONCURRENTLY IF EXISTS idx_tcm_encounter_cardiac_code;`
  );

  // Remove the column
  await queryInterface.sequelize.transaction(async transaction => {
    await queryInterface.removeColumn(tableName, columnName, { transaction });
  });
};

const cardiacCodes = [
  "R0789",
  "I4891",
  "R0602",
  "R079",
  "R531",
  "G459",
  "I110",
  "R002",
  "I469",
  "R55",
  "R42",
  "I10",
  "I200",
  "I201",
  "I208",
  "I209",
  "I2101",
  "I2102",
  "I2109",
  "I2111",
  "I2119",
  "I2121",
  "I2129",
  "I213",
  "I214",
  "I219",
  "I21A1",
  "I21A9",
  "I220",
  "I221",
  "I222",
  "I228",
  "I229",
  "I230",
  "I231",
  "I232",
  "I233",
  "I234",
  "I235",
  "I236",
  "I237",
  "I238",
  "I240",
  "I241",
  "I248",
  "I249",
  "I2510",
  "I25110",
  "I25111",
  "I25118",
  "I25119",
  "I252",
  "I253",
  "I2541",
  "I2542",
  "I255",
  "I256",
  "I25700",
  "I25701",
  "I25708",
  "I25709",
  "I25710",
  "I25711",
  "I25718",
  "I25719",
  "I25720",
  "I25721",
  "I25728",
  "I25729",
  "I25730",
  "I25731",
  "I25738",
  "I25739",
  "I25750",
  "I25751",
  "I25758",
  "I25759",
  "I25760",
  "I25761",
  "I25768",
  "I25769",
  "I25790",
  "I25791",
  "I25798",
  "I25799",
  "I25810",
  "I25811",
  "I25812",
  "I2582",
  "I2583",
  "I2584",
  "I2589",
  "I259",
  "I0981",
  "I501",
  "I5020",
  "I5021",
  "I5022",
  "I5023",
  "I5030",
  "I5031",
  "I5032",
  "I5033",
  "I5040",
  "I5041",
  "I5042",
  "I5043",
  "I50810",
  "I50811",
  "I50812",
  "I50813",
  "I50814",
  "I5082",
  "I5083",
  "I5084",
  "I5089",
  "I509",
  "I420",
  "I421",
  "I422",
  "I423",
  "I424",
  "I425",
  "I426",
  "I427",
  "I428",
  "I429",
  "I43",
  "I515",
  "I440",
  "I441",
  "I442",
  "I4430",
  "I4439",
  "I444",
  "I445",
  "I4460",
  "I4469",
  "I447",
  "I450",
  "I4510",
  "I4519",
  "I452",
  "I453",
  "I454",
  "I455",
  "I456",
  "I4581",
  "I4589",
  "I459",
  "I462",
  "I468",
  "I469",
  "I470",
  "I471",
  "I472",
  "I479",
  "I480",
  "I4811",
  "I4819",
  "I4820",
  "I4821",
  "I483",
  "I484",
  "I4891",
  "I4892",
  "I4901",
  "I4902",
  "I491",
  "I492",
  "I493",
  "I4940",
  "I4949",
  "I495",
  "I498",
  "I499",
  "I97110",
  "I97111",
  "I97120",
  "I97121",
  "I97130",
  "I97131",
  "I97190",
  "I97191",
  "I97710",
  "I97711",
  "I97790",
  "I97791",
  "R001",
  "I2601",
  "I2602",
  "I2609",
  "I2690",
  "I2692",
  "I2693",
  "I2694",
  "I2699",
  "I270",
  "I271",
  "I2720",
  "I2721",
  "I2722",
  "I2723",
  "I2724",
  "I2729",
  "I2781",
  "I2782",
  "I2783",
  "I2789",
  "I279",
  "I280",
  "I281",
  "I288",
  "I289",
  "I050",
  "I051",
  "I052",
  "I058",
  "I059",
  "I060",
  "I061",
  "I062",
  "I068",
  "I069",
  "I070",
  "I071",
  "I072",
  "I078",
  "I079",
  "I080",
  "I081",
  "I082",
  "I083",
  "I088",
  "I089",
  "I090",
  "I091",
  "I092",
  "I340",
  "I341",
  "I342",
  "I348",
  "I349",
  "I350",
  "I351",
  "I352",
  "I358",
  "I359",
  "I360",
  "I361",
  "I362",
  "I368",
  "I369",
  "I370",
  "I371",
  "I372",
  "I378",
  "I379",
  "I700",
  "I7100",
  "I7101",
  "I7102",
  "I7103",
  "I711",
  "I712",
  "I713",
  "I714",
  "I715",
  "I716",
  "I718",
  "I719",
  "I790",
  "I791",
  "I798",
  "I7411",
  "I748",
  "I7300",
  "I7301",
  "I731",
  "I7381",
  "I7389",
  "I739",
  "I770",
  "I771",
  "I772",
  "I773",
  "I774",
  "I775",
  "I776",
  "I7770",
  "I7771",
  "I7772",
  "I7773",
  "I7774",
  "I7775",
  "I7776",
  "I7777",
  "I7779",
  "I77810",
  "I77811",
  "I77812",
  "I77819",
  "I7789",
  "I779",
  "I82501",
  "I82502",
  "I82503",
  "I82509",
  "I82511",
  "I82512",
  "I82513",
  "I82519",
  "I82521",
  "I82522",
  "I82523",
  "I82529",
  "I82531",
  "I82532",
  "I82533",
  "I82539",
  "I82541",
  "I82542",
  "I82543",
  "I82549",
  "I82551",
  "I82552",
  "I82553",
  "I82559",
  "I82561",
  "I82562",
  "I82563",
  "I82569",
  "I82591",
  "I82592",
  "I82593",
  "I82599",
  "I825Y1",
  "I825Y2",
  "I825Y3",
  "I825Y9",
  "I825Z1",
  "I825Z2",
  "I825Z3",
  "I825Z9",
  "I70",
  "I83",
  "I700",
  "I701",
  "I702",
  "I703",
  "I704",
  "I705",
  "I706",
  "I707",
  "I708",
  "I709",
  "I830",
  "I831",
  "I832",
  "I838",
  "I839",
  "I7020",
  "I7021",
  "I7022",
  "I7023",
  "I7024",
  "I7025",
  "I7026",
  "I7029",
  "I7030",
  "I7031",
  "I7032",
  "I7033",
  "I7034",
  "I7035",
  "I7036",
  "I7039",
  "I7040",
  "I7041",
  "I7042",
  "I7043",
  "I7044",
  "I7045",
  "I7046",
  "I7049",
  "I7050",
  "I7051",
  "I7052",
  "I7053",
  "I7054",
  "I7055",
  "I7056",
  "I7059",
  "I7060",
  "I7061",
  "I7062",
  "I7063",
  "I7064",
  "I7065",
  "I7066",
  "I7069",
  "I7070",
  "I7071",
  "I7072",
  "I7073",
  "I7074",
  "I7075",
  "I7076",
  "I7079",
  "I7090",
  "I7091",
  "I7092",
  "I8300",
  "I8301",
  "I8302",
  "I8310",
  "I8311",
  "I8312",
  "I8320",
  "I8321",
  "I8322",
  "I8381",
  "I8389",
  "I8390",
  "I8391",
  "I8392",
  "I8393",
  "R07.89",
  "I48.91",
  "R06.02",
  "R07.9",
  "R53.1",
  "G45.9",
  "I11.0",
  "R00.2",
  "I46.9",
  "R55",
  "R42",
  "I10",
  "I20.0",
  "I20.1",
  "I20.8",
  "I20.9",
  "I21.01",
  "I21.02",
  "I21.09",
  "I21.11",
  "I21.19",
  "I21.21",
  "I21.29",
  "I21.3",
  "I21.4",
  "I21.9",
  "I21.A1",
  "I21.A9",
  "I22.0",
  "I22.1",
  "I22.2",
  "I22.8",
  "I22.9",
  "I23.0",
  "I23.1",
  "I23.2",
  "I23.3",
  "I23.4",
  "I23.5",
  "I23.6",
  "I23.7",
  "I23.8",
  "I24.0",
  "I24.1",
  "I24.8",
  "I24.9",
  "I25.10",
  "I25.110",
  "I25.111",
  "I25.118",
  "I25.119",
  "I25.2",
  "I25.3",
  "I25.41",
  "I25.42",
  "I25.5",
  "I25.6",
  "I25.700",
  "I25.701",
  "I25.708",
  "I25.709",
  "I25.710",
  "I25.711",
  "I25.718",
  "I25.719",
  "I25.720",
  "I25.721",
  "I25.728",
  "I25.729",
  "I25.730",
  "I25.731",
  "I25.738",
  "I25.739",
  "I25.750",
  "I25.751",
  "I25.758",
  "I25.759",
  "I25.760",
  "I25.761",
  "I25.768",
  "I25.769",
  "I25.790",
  "I25.791",
  "I25.798",
  "I25.799",
  "I25.810",
  "I25.811",
  "I25.812",
  "I25.82",
  "I25.83",
  "I25.84",
  "I25.89",
  "I25.9",
  "I09.81",
  "I50.1",
  "I50.20",
  "I50.21",
  "I50.22",
  "I50.23",
  "I50.30",
  "I50.31",
  "I50.32",
  "I50.33",
  "I50.40",
  "I50.41",
  "I50.42",
  "I50.43",
  "I50.810",
  "I50.811",
  "I50.812",
  "I50.813",
  "I50.814",
  "I50.82",
  "I50.83",
  "I50.84",
  "I50.89",
  "I50.9",
  "I42.0",
  "I42.1",
  "I42.2",
  "I42.3",
  "I42.4",
  "I42.5",
  "I42.6",
  "I42.7",
  "I42.8",
  "I42.9",
  "I43",
  "I51.5",
  "I44.0",
  "I44.1",
  "I44.2",
  "I44.30",
  "I44.39",
  "I44.4",
  "I44.5",
  "I44.60",
  "I44.69",
  "I44.7",
  "I45.0",
  "I45.10",
  "I45.19",
  "I45.2",
  "I45.3",
  "I45.4",
  "I45.5",
  "I45.6",
  "I45.81",
  "I45.89",
  "I45.9",
  "I46.2",
  "I46.8",
  "I46.9",
  "I47.0",
  "I47.1",
  "I47.2",
  "I47.9",
  "I48.0",
  "I48.11",
  "I48.19",
  "I48.20",
  "I48.21",
  "I48.3",
  "I48.4",
  "I48.91",
  "I48.92",
  "I49.01",
  "I49.02",
  "I49.1",
  "I49.2",
  "I49.3",
  "I49.40",
  "I49.49",
  "I49.5",
  "I49.8",
  "I49.9",
  "I97.110",
  "I97.111",
  "I97.120",
  "I97.121",
  "I97.130",
  "I97.131",
  "I97.190",
  "I97.191",
  "I97.710",
  "I97.711",
  "I97.790",
  "I97.791",
  "R00.1",
  "I26.01",
  "I26.02",
  "I26.09",
  "I26.90",
  "I26.92",
  "I26.93",
  "I26.94",
  "I26.99",
  "I27.0",
  "I27.1",
  "I27.20",
  "I27.21",
  "I27.22",
  "I27.23",
  "I27.24",
  "I27.29",
  "I27.81",
  "I27.82",
  "I27.83",
  "I27.89",
  "I27.9",
  "I28.0",
  "I28.1",
  "I28.8",
  "I28.9",
  "I05.0",
  "I05.1",
  "I05.2",
  "I05.8",
  "I05.9",
  "I06.0",
  "I06.1",
  "I06.2",
  "I06.8",
  "I06.9",
  "I07.0",
  "I07.1",
  "I07.2",
  "I07.8",
  "I07.9",
  "I08.0",
  "I08.1",
  "I08.2",
  "I08.3",
  "I08.8",
  "I08.9",
  "I09.0",
  "I09.1",
  "I09.2",
  "I34.0",
  "I34.1",
  "I34.2",
  "I34.8",
  "I34.9",
  "I35.0",
  "I35.1",
  "I35.2",
  "I35.8",
  "I35.9",
  "I36.0",
  "I36.1",
  "I36.2",
  "I36.8",
  "I36.9",
  "I37.0",
  "I37.1",
  "I37.2",
  "I37.8",
  "I37.9",
  "I70.0",
  "I71.00",
  "I71.01",
  "I71.02",
  "I71.03",
  "I71.1",
  "I71.2",
  "I71.3",
  "I71.4",
  "I71.5",
  "I71.6",
  "I71.8",
  "I71.9",
  "I79.0",
  "I79.1",
  "I79.8",
  "I74.11",
  "I74.8",
  "I73.00",
  "I73.01",
  "I73.1",
  "I73.81",
  "I73.89",
  "I73.9",
  "I77.0",
  "I77.1",
  "I77.2",
  "I77.3",
  "I77.4",
  "I77.5",
  "I77.6",
  "I77.70",
  "I77.71",
  "I77.72",
  "I77.73",
  "I77.74",
  "I77.75",
  "I77.76",
  "I77.77",
  "I77.79",
  "I77.810",
  "I77.811",
  "I77.812",
  "I77.819",
  "I77.89",
  "I77.9",
  "I82.501",
  "I82.502",
  "I82.503",
  "I82.509",
  "I82.511",
  "I82.512",
  "I82.513",
  "I82.519",
  "I82.521",
  "I82.522",
  "I82.523",
  "I82.529",
  "I82.531",
  "I82.532",
  "I82.533",
  "I82.539",
  "I82.541",
  "I82.542",
  "I82.543",
  "I82.549",
  "I82.551",
  "I82.552",
  "I82.553",
  "I82.559",
  "I82.561",
  "I82.562",
  "I82.563",
  "I82.569",
  "I82.591",
  "I82.592",
  "I82.593",
  "I82.599",
  "I82.5Y1",
  "I82.5Y2",
  "I82.5Y3",
  "I82.5Y9",
  "I82.5Z1",
  "I82.5Z2",
  "I82.5Z3",
  "I82.5Z9",
  "I70",
  "I83",
  "I70.0",
  "I70.1",
  "I70.2",
  "I70.3",
  "I70.4",
  "I70.5",
  "I70.6",
  "I70.7",
  "I70.8",
  "I70.9",
  "I83.0",
  "I83.1",
  "I83.2",
  "I83.8",
  "I83.9",
  "I70.20",
  "I70.21",
  "I70.22",
  "I70.23",
  "I70.24",
  "I70.25",
  "I70.26",
  "I70.29",
  "I70.30",
  "I70.31",
  "I70.32",
  "I70.33",
  "I70.34",
  "I70.35",
  "I70.36",
  "I70.39",
  "I70.40",
  "I70.41",
  "I70.42",
  "I70.43",
  "I70.44",
  "I70.45",
  "I70.46",
  "I70.49",
  "I70.50",
  "I70.51",
  "I70.52",
  "I70.53",
  "I70.54",
  "I70.55",
  "I70.56",
  "I70.59",
  "I70.60",
  "I70.61",
  "I70.62",
  "I70.63",
  "I70.64",
  "I70.65",
  "I70.66",
  "I70.69",
  "I70.70",
  "I70.71",
  "I70.72",
  "I70.73",
  "I70.74",
  "I70.75",
  "I70.76",
  "I70.79",
  "I70.90",
  "I70.91",
  "I70.92",
  "I83.00",
  "I83.01",
  "I83.02",
  "I83.10",
  "I83.11",
  "I83.12",
  "I83.20",
  "I83.21",
  "I83.22",
  "I83.81",
  "I83.89",
  "I83.90",
  "I83.91",
  "I83.92",
  "I83.93",
];
