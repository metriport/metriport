
-- SELECT statement for Immunization
SELECT 
    resourcetype,
    id,
    meta_versionid,
    meta_lastupdated,
    meta_source,
    identifier_0_system,
    identifier_0_value,
    status,
    vaccinecode_coding_0_system,
    vaccinecode_coding_0_code,
    vaccinecode_coding_0_display,
    vaccinecode_coding_1_system,
    vaccinecode_coding_1_code,
    vaccinecode_coding_1_display,
    vaccinecode_text,
    patient_reference,
    occurrencedatetime,
    manufacturer_display,
    lotnumber,
    site_text,
    route_text,
    dosequantity_value,
    dosequantity_unit,
    dosequantity_system,
    performer_0_actor_reference,
    performer_1_actor_reference,
    performer_2_actor_reference,
    performer_3_actor_reference,
    performer_4_actor_reference,
    performer_5_actor_reference,
    performer_6_actor_reference,
    identifier_1_system,
    identifier_1_value,
    identifier_2_system,
    identifier_2_value,
    route_coding_0_system,
    route_coding_0_code,
    performer_7_actor_reference,
    performer_8_actor_reference,
    statusreason_text,
    site_coding_0_system,
    site_coding_0_code,
    identifier_1_assigner_display,
    identifier_1_type_text,
    identifier_2_assigner_display,
    identifier_2_type_text,
    route_coding_0_display,
    identifier_0_type_text,
    identifier_3_system,
    identifier_3_value,
    identifier_4_system,
    identifier_4_value,
    vaccinecode_coding_2_code,
    vaccinecode_coding_2_display,
    vaccinecode_coding_2_system,
    occurrencestring,
    identifier_3_assigner_display,
    identifier_3_type_text,
    performer_9_actor_reference,
    identifier_5_system,
    identifier_5_value,
    performer_10_actor_reference,
    performer_11_actor_reference,
    site_coding_0_display,
    filename,
    processed_date 
FROM {{source('raw', 'immunization') }} x

QUALIFY rank() over(partition by filename order by processed_date desc) = 1