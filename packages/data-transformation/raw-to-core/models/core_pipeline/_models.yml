version: 2

models:
  - name: core__condition
    schema: core_v3
    alias: condition
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: recorder_practitioner_id
        tests:
          - relationships:
              to: ref('core__practitioner')
              field: practitioner_id
              config:
                where: recorder_practitioner_id != ''
                severity: warn
  - name: core__diagnostic_report_references
    schema: core_v3
    enabled: false
    alias: diagnostic_report_references
    materialized: table
    columns:
      - name: diagnostic_report_id
        tests:
          - relationships:
              to: ref('core__diagnostic_report')
              field: diagnostic_report_id
              config:
                severity: error
      - name: reference_id
        tests:
          - relationships:
              to: ref('core__observation')
              field: observation_id
              config:
                where: reference_type = 'Observation'
                severity: error
  - name: core__diagnostic_report
    schema: core_v3
    enabled: false
    alias: diagnostic_report
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: encounter_id
        tests:
          - relationships:
              to: ref('core__encounter')
              field: encounter_id
              config:
                where: encounter_id != ''
                severity: warn
      - name: performer_practitioner_id
        tests:
          - relationships:
              to: ref('core__practitioner')
              field: practitioner_id
              config:
                where: performer_practitioner_id != ''
                severity: warn
      - name: performer_organization_id
        tests:
          - relationships:
              to: ref('core__organization')
              field: organization_id
              config:
                where: performer_organization_id != ''
                severity: warn
  - name: core__encounter_references
    schema: core_v3
    enabled: false
    alias: encounter_references
    materialized: table
    columns:
      - name: encounter_id
        tests:
          - relationships:
              to: ref('core__encounter')
              field: encounter_id
              config:
                severity: warn
      - name: reference_id
        tests:
          - relationships:
              to: ref('core__condition')
              field: condition_id
              config:
                where: reference_type = 'Condition'
                severity: warn
  - name: core__encounter
    schema: core_v3
    enabled: false
    alias: encounter
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: location_id
        tests:
          - relationships:
              to: ref('core__location')
              field: location_id
              config:
                where: location_id != ''
                severity: warn
      - name: organization_id
        tests:
          - relationships:
              to: ref('core__organization')
              field: organization_id
              config:
                where: organization_id != ''
                severity: warn
  - name: core__immunization
    schema: core_v3
    enabled: false
    alias: immunization
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: performer_practitioner_id
        tests:
          - relationships:
              to: ref('core__practitioner')
              field: practitioner_id
              config:
                where: performer_practitioner_id != ''
                severity: warn
      - name: performer_organization_id
        tests:
          - relationships:
              to: ref('core__organization')
              field: organization_id
              config:
                where: performer_organization_id != ''
                severity: warn
  - name: core__location
    schema: core_v3
    enabled: false
    alias: location
    materialized: table
    columns:
      - name: managing_organization_id
        tests:
          - relationships:
              to: ref('core__organization')
              field: organization_id
              config:
                where: managing_organization_id != ''
                severity: warn
  - name: core__medication
    schema: core_v3
    enabled: false
    alias: medication
    materialized: table
  - name: core__medication_administration
    schema: core_v3
    enabled: false
    alias: medication_administration
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: medication_id
        tests:
          - relationships:
              to: ref('core__medication')
              field: medication_id
              config:
                severity: error
      - name: performer_practitioner_id
        tests:
          - relationships:
              to: ref('core__practitioner')
              field: practitioner_id
              config:
                where: performer_practitioner_id != ''
                severity: warn
      - name: performer_organization_id
        tests:
          - relationships:
              to: ref('core__organization')
              field: organization_id
              config:
                where: performer_organization_id != ''
                severity: warn
  - name: core__medication_dispense
    schema: core_v3
    enabled: false
    alias: medication_dispense
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: medication_id
        tests:
          - relationships:
              to: ref('core__medication')
              field: medication_id
              config:
                severity: error
      - name: performer_practitioner_id
        tests:
          - relationships:
              to: ref('core__practitioner')
              field: practitioner_id
              config:
                where: performer_practitioner_id != ''
                severity: warn
      - name: performer_organization_id
        tests:
          - relationships:
              to: ref('core__organization')
              field: organization_id
              config:
                where: performer_organization_id != ''
                severity: warn
      - name: location_id
        tests:
          - relationships:
              to: ref('core__location')
              field: location_id
              config:
                where: location_id != ''
                severity: warn
  - name: core__medication_request
    schema: core_v3
    enabled: false
    alias: medication_request
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: medication_id
        tests:
          - relationships:
              to: ref('core__medication')
              field: medication_id
              config:
                severity: error
      - name: requester_practitioner_id
        tests:
          - relationships:
              to: ref('core__practitioner')
              field: practitioner_id
              config:
                where: requester_practitioner_id != ''
                severity: warn
      - name: requester_organization_id
        tests:
          - relationships:
              to: ref('core__organization')
              field: organization_id
              config:
                where: requester_organization_id != ''
                severity: warn
  - name: core__medication_statement
    schema: core_v3
    enabled: false
    alias: medication_statement
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: medication_id
        tests:
          - relationships:
              to: ref('core__medication')
              field: medication_id
              config:
                severity: error
  - name: core__observation
    schema: core_v3
    enabled: false
    alias: observation
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: performer_practitioner_id
        tests:
          - relationships:
              to: ref('core__practitioner')
              field: practitioner_id
              config:
                where: performer_practitioner_id != ''
                severity: warn
      - name: performer_organization_id
        tests:
          - relationships:
              to: ref('core__organization')
              field: organization_id
              config:
                where: performer_organization_id != ''
                severity: warn
  - name: core__organization
    schema: core_v3
    enabled: false
    alias: organization
    materialized: table
  - name: core__patient
    schema: core_v3
    alias: patient
    materialized: table
  - name: core__practitioner
    schema: core_v3
    enabled: false
    alias: practitioner
    materialized: table
  - name: core__procedure_references
    schema: core_v3
    enabled: false
    alias: procedure_references
    materialized: table
    columns:
      - name: procedure_id
        tests:
          - relationships:
              to: ref('core__procedure')
              field: procedure_id
              config:
                severity: error
      - name: reference_id
        tests:
          - relationships:
              to: ref('core__diagnostic_report')
              field: diagnostic_report_id
              config:
                where: reference_type = 'DiagnosticReport'
                severity: error
  - name: core__procedure
    schema: core_v3
    alias: procedure
    materialized: table
    columns:
      - name: patient_id
        tests:
          - relationships:
              to: ref('core__patient')
              field: patient_id
              config:
                severity: error
      - name: performer_practitioner_id
        tests:
          - relationships:
              to: ref('core__practitioner')
              field: practitioner_id
              config:
                where: performer_practitioner_id != ''
                severity: warn
      - name: performer_organization_id
        tests:
          - relationships:
              to: ref('core__organization')
              field: organization_id
              config:
                where: performer_organization_id != ''
                severity: warn
